import OpenAI from "openai";

const client = new OpenAI({
  apiKey: process.env.GROQ_API_KEY,
  baseURL: "https://api.groq.com/openai/v1",
});

interface StoryChoice {
  id: string;
  text: string;
  impact: {
    money: number;
    energy: number;
    mood: number;
  };
}

interface Lesson {
  title: string;
  text: string;
  icon: string;
}

interface EducationalContent {
  title: string;
  text: string;
  icon: string;
}

export interface LifeStory {
  day: number;
  title: string;
  description: string;
  context: string;
  choices: StoryChoice[];
  lesson: Lesson;
  isRandomEvent?: boolean;
  educationalContent?: EducationalContent;
}

export async function generateLifeStories(
  age: number,
  playerName: string
): Promise<LifeStory[]> {
  const prompt = `–¢—ã —Å–æ–∑–¥–∞—ë—à—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä –∂–∏–∑–Ω–∏ –¥–ª—è –∏–≥—Ä–æ–∫–∞ –ø–æ –∏–º–µ–Ω–∏ ${playerName}, –≤–æ–∑—Ä–∞—Å—Ç ${age} –ª–µ—Ç. 
–ì–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞ - —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å –∏ –±–∞–Ω–∫–∏–Ω–≥.

–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –°–æ–∑–¥–∞–π —Ä–æ–≤–Ω–æ 12 –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π (–∫–∞–∫ 12 –º–µ—Å—è—Ü–µ–≤ –≥–æ–¥–∞)
2. –°–∏—Ç—É–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞ ${age} –ª–µ—Ç –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π
3. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∏ 5-6 —Å–∏—Ç—É–∞—Ü–∏–π —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–∞–Ω–∫–∏–Ω–≥–æ–º: –∫—Ä–µ–¥–∏—Ç—ã, –∏–ø–æ—Ç–µ–∫–∞, –¥–æ–ª–≥–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è, –∫–∞—Ä—Ç—ã
4. 3-4 —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ª—É—á–∞–π–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ - —É–¥–∞—á–∞/–Ω–µ–≤–µ–∑–µ–Ω–∏–µ (–ø–æ–º–µ—Ç—å isRandomEvent: true)
5. –î–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å educationalContent - –∫—Ä–∞—Ç–∫–∏–π —É—Ä–æ–∫ –î–û —Å–∏—Ç—É–∞—Ü–∏–∏ (—á—Ç–æ —Ç–∞–∫–æ–µ –∫—Ä–µ–¥–∏—Ç, –∏–ø–æ—Ç–µ–∫–∞ –∏ —Ç.–¥.)
6. –ö–∞–∂–¥–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –∏–º–µ–µ—Ç 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤—ã–±–æ—Ä–∞ —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –∏ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤–ª–∏—è–Ω–∏–µ–º –Ω–∞ –¥–µ–Ω—å–≥–∏/—ç–Ω–µ—Ä–≥–∏—é/–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
7. –¢–µ–∫—Å—Ç –∂–∏–≤–æ–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, —Å –¥–µ—Ç–∞–ª—è–º–∏. –ò–∑–±–µ–≥–∞–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π –∏ –æ–±—â–∏—Ö —Ñ—Ä–∞–∑

–ü–†–ò–ù–¶–ò–ü–´ –°–û–ó–î–ê–ù–ò–Ø –í–´–ë–û–†–û–í:
- –ö–∞–∂–¥—ã–π –≤—ã–±–æ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ª–æ–≥–∏—á–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è (–Ω–µ –ø—Ä–æ—Å—Ç–æ +/- —á–∏—Å–ª–∞, –∞ –ø–æ–Ω—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–≤—è–∑—å)
- –ò–∑–±–µ–≥–∞–π –æ—á–µ–≤–∏–¥–Ω–æ "–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" –∏–ª–∏ "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ - –≤—Å–µ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã
- –°—É–º–º—ã –¥–µ–Ω–µ–≥ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞ (–Ω–µ "¬±50", –∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—É–º–º—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ)
- –í–ª–∏—è–Ω–∏–µ –Ω–∞ —ç–Ω–µ—Ä–≥–∏—é –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ª–æ–≥–∏—á–Ω—ã–º (—Å—Ç—Ä–µ—Å—Å = -—ç–Ω–µ—Ä–≥–∏—è/-–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —É—Å–ø–µ—Ö = +–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ)

–ö–û–ù–¢–ï–ö–°–¢ –ü–û –í–û–ó–†–ê–°–¢–£:
- 10-15 –ª–µ—Ç: –∫–∞—Ä–º–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏ 500-2000‚ÇΩ, –ø–µ—Ä–≤—ã–µ –ø–æ–∫—É–ø–∫–∏, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –Ω–∞ –º–µ—á—Ç—É, –ø–æ–º–æ—â—å —Ä–æ–¥–∏—Ç–µ–ª—è–º, —à–∫–æ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
- 16-20 –ª–µ—Ç: –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞ 5-15 —Ç—ã—Å‚ÇΩ, —É—á—ë–±–∞, —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –∂–∏–∑–Ω—å, –ø–µ—Ä–≤–∞—è –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞, –Ω–µ–±–æ–ª—å—à–∏–µ –∑–∞–π–º—ã
- 21-30 –ª–µ—Ç: –∑–∞—Ä–ø–ª–∞—Ç–∞ 30-80 —Ç—ã—Å‚ÇΩ, –∞—Ä–µ–Ω–¥–∞ 15-30 —Ç—ã—Å‚ÇΩ, –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–µ –∫—Ä–µ–¥–∏—Ç—ã –¥–æ 300 —Ç—ã—Å‚ÇΩ, –∫–∞—Ä—å–µ—Ä–∞, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –Ω–∞ –∫—Ä—É–ø–Ω—ã–µ —Ü–µ–ª–∏
- 31-45 –ª–µ—Ç: –∑–∞—Ä–ø–ª–∞—Ç–∞ 60-150 —Ç—ã—Å‚ÇΩ, –∏–ø–æ—Ç–µ–∫–∞ 3-8 –º–ª–Ω‚ÇΩ, —Å–µ–º—å—è, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–µ–π, –≤–æ–∑–º–æ–∂–µ–Ω –±–∏–∑–Ω–µ—Å
- 46+ –ª–µ—Ç: –¥–æ—Ö–æ–¥ 80-200+ —Ç—ã—Å‚ÇΩ, –ø–µ–Ω—Å–∏–æ–Ω–Ω—ã–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è, –ø–æ–º–æ—â—å –¥–µ—Ç—è–º/–≤–Ω—É–∫–∞–º, –∫—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏, –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª

–°–õ–£–ß–ê–ô–ù–´–ï –°–û–ë–´–¢–ò–Ø (3-4 —à—Ç—É–∫–∏):
- –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã/–ø—Ä–µ–º–∏—è
- –í—ã–∏–≥—Ä—ã—à –≤ –ª–æ—Ç–µ—Ä–µ—é/–∫–µ—à–±—ç–∫/–≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–ª–æ–≥–æ–≤
- –ü–æ–ª–æ–º–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∏/–º–∞—à–∏–Ω—ã/—Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∏
- –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤/–Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ
- –®—Ç—Ä–∞—Ñ/–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã/–º–µ–¥–∏—Ü–∏–Ω–∞

–§–û–†–ú–ê–¢ educationalContent (–¥–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Ç–µ–º):
{
  "title": "–ß—Ç–æ —Ç–∞–∫–æ–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–π –∫—Ä–µ–¥–∏—Ç?",
  "text": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø—Ä–∏–º–µ—Ä–æ–º",
  "icon": "üè¶"
}

–§–û–†–ú–ê–¢ lesson (–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏):
{
  "title": "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—Ä–æ–∫",
  "text": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤—ã–≤–æ–¥ –∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ - —á—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
  "icon": "üí°"
}

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê - –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –º–∞—Å—Å–∏–≤:
[
  {
    "day": 1,
    "title": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–µ –æ–±—â–µ–µ)",
    "description": "–Ø—Ä–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏",
    "context": "–ß–µ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å - —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ä–µ—à–∞–µ—Ç –∏–≥—Ä–æ–∫?",
    "choices": [
      {
        "id": "choice1",
        "text": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏",
        "impact": { "money": 1000, "energy": -10, "mood": 20 }
      },
      {
        "id": "choice2", 
        "text": "–î—Ä—É–≥–æ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ",
        "impact": { "money": -500, "energy": 10, "mood": -10 }
      },
      {
        "id": "choice3",
        "text": "–¢—Ä–µ—Ç–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –Ω—é–∞–Ω—Å–∞–º–∏",
        "impact": { "money": 0, "energy": 5, "mood": 5 }
      }
    ],
    "lesson": {
      "title": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —É—Ä–æ–∫",
      "text": "–ü—Ä–∏–º–µ–Ω–∏–º—ã–π —Å–æ–≤–µ—Ç –∏–∑ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏",
      "icon": "üí°"
    },
    "isRandomEvent": false,
    "educationalContent": {
      "title": "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω",
      "text": "–ü–æ–Ω—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–æ–º",
      "icon": "üè¶"
    }
  }
]

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: 
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ —Ç–∏–ø–∞ "–≤–∞—Ä–∏–∞–Ω—Ç –ê", "—É–º–µ—Ä–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä"
- –í—Å–µ —Å—É–º–º—ã –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–æ–∑—Ä–∞—Å—Ç—É –∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏
- –ö–∞–∂–¥—ã–π –≤—ã–±–æ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π –¥–∏–ª–µ–º–º–æ–π, –∞ –Ω–µ –æ—á–µ–≤–∏–¥–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º
- –°–∏—Ç—É–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É—Å–ª–æ–∂–Ω—è—Ç—å—Å—è –æ—Ç 1 –¥–æ 12

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏ –ø–æ—Å–ª–µ!`;

  try {
    const completion = await client.chat.completions.create({
      model: "llama-3.3-70b-versatile", // –°–∞–º–∞—è –º–æ—â–Ω–∞—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å Groq
      messages: [
        {
          role: "system",
          content:
            "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Å–æ–∑–¥–∞—Ç–µ–ª—å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∏–≥—Ä. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.",
        },
        {
          role: "user",
          content: prompt,
        },
      ],
      temperature: 0.8,
      max_tokens: 8000,
    });

    const text = completion.choices[0].message.content || "";

    // –û—á–∏—Å—Ç–∫–∞ –æ—Ç markdown
    let jsonText = text.trim();
    jsonText = jsonText.replace(/```json\n?/g, "").replace(/```\n?/g, "");

    const stories: LifeStory[] = JSON.parse(jsonText);

    if (!Array.isArray(stories) || stories.length !== 12) {
      throw new Error(`AI –≤–µ—Ä–Ω—É–ª ${stories.length} –∏—Å—Ç–æ—Ä–∏–π –≤–º–µ—Å—Ç–æ 12`);
    }

    return stories;
  } catch (error: any) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–π:", error);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
    if (error.status === 429) {
      throw new Error(
        "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É."
      );
    }

    if (error.status === 402) {
      throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ AI API");
    }

    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏–∏");
  }
}
